#!/bin/bash
#
# backup - runs as a scheduled task
#
# zip options are:
#    FS - filesync (update zip with new or changed files, remove any deleted files)
#    r  - recurse into subdirectories
#    x  - exclude these (in this case hidden files/directories) 

if [ "$BACKUPS" == "" ] ; then
    echo "Error: BACKUPS environment variable not set."    
    exit
fi

log=$BACKUPS/backup-log.txt 

do-folder()  { echo "Zipping up $1" >> $log ; zip -FSr $BACKUPS/$1.zip $HOME/$1 -x .*   >> $log ; }  

echo "Backup Started" > $log

for d in $(find $HOME -maxdepth 1 -not -path '*/.*' -type d) ; do
    if [ "$d" != "$HOME" ]; then
		if [ ! -z "$( ls -A $d )" ]; then
			do-folder $(basename $d)
		fi	
    fi
done

if [ "$BACKUP_REMOTE" != "" ] ; then
	if [ "$SSHPASS" == "" ] ; then
	    echo "Error: SSHPASS environment variable not set."    
    else
		sshpass -e rsync -utp $BACKUPS/* $BACKUP_REMOTE
	fi
fi
